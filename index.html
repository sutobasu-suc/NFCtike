<!DOCTYPE html>
<html lang="ja">
<head>
  <title>チケット在庫管理（NFC認証付き）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      background: #f9f9f9;
    }
    .ticket {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button {
      padding: 8px 12px;
      margin-top: 5px;
    }
    #adminMenu {
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <h2> チケット在庫一覧</h2>
  <div id="ticketList"></div>
  <hr>
  <button onclick="startPurchase()"> 購入する</button>
  <button onclick="openAdmin()"> 管理者メニュー</button>
  <div id="adminMenu">
    <h3>管理者メニュー</h3>
    <input id="newName" placeholder="券種名">
    <input id="newStock" type="number" placeholder="初期在庫">
    <button onclick="addTicket()">追加</button>
    <button onclick="resetAll()">在庫リセット</button>
  </div>

  <script>
    let db;
    const DB_NAME = "TicketDB";
    const STORE_NAME = "tickets";
    const UID_KEY = "nfcUID";

    async function initDB() {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
      };
      req.onsuccess = (e) => {
        db = e.target.result;
        loadTickets();
        checkFirstLaunch();
      };
    }

    function loadTickets() {
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const req = store.getAll();
      req.onsuccess = () => {
        displayTickets(req.result);
      };
    }

    function displayTickets(tickets) {
      const list = document.getElementById("ticketList");
      list.innerHTML = "";
      tickets.forEach(t => {
        const div = document.createElement("div");
        div.className = "ticket";
        div.innerHTML = `<b>${t.name}</b><br>在庫：<span id="stock-${t.id}">${t.stock}</span>`;
        list.appendChild(div);
      });
    }

    function addTicket() {
      requireAuth(async () => {
        const name = document.getElementById("newName").value;
        const stock = parseInt(document.getElementById("newStock").value);
        if (!name || isNaN(stock)) return alert("正しい名前と在庫を入力してください");
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).add({ name, stock });
        tx.oncomplete = loadTickets;
      });
    }

    function resetAll() {
      requireAuth(() => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).clear();
        tx.oncomplete = loadTickets;
      });
    }

    function startPurchase() {
      requireAuth(() => {
        const id = prompt("購入するチケットのID（1など）を入力してください");
        if (!id) return;
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const getReq = store.get(Number(id));
        getReq.onsuccess = () => {
          const ticket = getReq.result;
          if (ticket && ticket.stock > 0) {
            ticket.stock--;
            store.put(ticket);
            document.getElementById(`stock-${ticket.id}`).textContent = ticket.stock;
          } else {
            alert("在庫なし or 該当なし");
          }
        };
      });
    }

    function openAdmin() {
      requireAuth(() => {
        document.getElementById("adminMenu").style.display = "block";
      });
    }

    async function checkFirstLaunch() {
      const savedUID = localStorage.getItem(UID_KEY);
      if (!savedUID) {
        alert("初回のカードをスキャンしてください（管理用）");
        try {
          const uid = await scanNFC();
          localStorage.setItem(UID_KEY, uid);
          alert("カードを登録しました");
        } catch {
          alert("NFCがサポートされていません");
        }
      }
    }

    async function requireAuth(callback) {
      const savedUID = localStorage.getItem(UID_KEY);
      try {
        const currentUID = await scanNFC();
        if (currentUID === savedUID) {
          callback();
        } else {
          alert("認証失敗：このカードでは操作できません");
        }
      } catch {
        alert("NFC認証に失敗しました");
      }
    }

    async function scanNFC() {
      if (!("NDEFReader" in window)) throw new Error("NFC非対応");
      const reader = new NDEFReader();
      await reader.scan();
      return new Promise((resolve, reject) => {
        reader.onreading = (event) => {
          const serial = event.serialNumber;
          if (serial) resolve(serial);
          else reject();
        };
        reader.onerror = () => reject();
      });
    }

    initDB();
  </script>
</body>
</html>
